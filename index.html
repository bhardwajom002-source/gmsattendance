<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Date-Wise Attendance System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- SheetJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    body { font-family: Arial; background: #eef2f5; margin:0; padding:0; }
    .box, .container {
        width: 90%; max-width: 900px; margin: 40px auto;
        background: white; padding: 25px;
        border-radius: 12px; box-shadow: 0 0 10px #bbb;
    }
    h2 { text-align: center; }

    input, button {
        padding: 10px; margin:5px; border-radius:6px;
        border:1px solid #aaa;
    }
    button {cursor:pointer; border:none; color:white;}

    .btn-login{background:#28a745; width:100%;}
    .btn-add{background:#28a745;}
    .btn-present{background:#28a745;}
    .btn-absent{background:#dc3545;}
    .btn-edit{background:#007bff;}
    .btn-delete{background:#dc3545;}
    .btn-export{background:#444;}
    .btn-logout{background:#dc3545; float:right;}

    table {width:100%; border-collapse:collapse; margin-top:15px;}
    th {background:#37a835; color:white; padding:10px;}
    td {padding:10px; border-bottom:1px solid #ddd;}

    .present {color:green; font-weight:bold;}
    .absent {color:red; font-weight:bold;}
</style>
</head>

<body>

<!-- LOGIN PAGE -->
<div id="loginPage" class="box">
    <h2>Login</h2>

    <input type="text" id="loginUser" placeholder="Enter Username">
    <input type="password" id="loginPass" placeholder="Enter Password">

    <button class="btn-login" onclick="login()">Login</button>
</div>

<!-- MAIN PAGE -->
<div id="mainPage" class="container" style="display:none;">
    <button class="btn-logout" onclick="logout()">Logout</button>
    <h2>Date-Wise Attendance System</h2>

    <input type="date" id="datePicker" onchange="loadAttendance()">
    <br><br>

    <input type="text" id="studentName" placeholder="Student Name">
    <input type="text" id="fatherName" placeholder="Father Name">
    <button class="btn-add" onclick="addStudent()">Add Student</button>

    <br><br>

    <button class="btn-export" onclick="exportExcel()">Export Excel</button>
    <button class="btn-export" onclick="exportPDF()">Export PDF</button>

    <table>
        <thead>
            <tr>
                <th>Roll</th>
                <th>Name</th>
                <th>Father Name</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="attendanceBody"></tbody>
    </table>
</div>

<script>
/* ---------------- LOGIN ---------------- */
function login() {
    let u = document.getElementById("loginUser").value.trim();
    let p = document.getElementById("loginPass").value.trim();

    if (u === "rekha" && p === "rekha") {
        localStorage.setItem("loggedIn", "true");
        document.getElementById("loginPage").style.display = "none";
        document.getElementById("mainPage").style.display = "block";
    } else {
        alert("Wrong Username or Password");
    }
}

function logout() {
    localStorage.removeItem("loggedIn");
    location.reload();
}

if (localStorage.getItem("loggedIn") === "true") {
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("mainPage").style.display = "block";
}

/* ---------------- STUDENT & ATTENDANCE ---------------- */

let students = JSON.parse(localStorage.getItem("students")) || [];
let attendance = JSON.parse(localStorage.getItem("attendance")) || {};  
// attendance["2025-02-10"] = [{roll, status}]

const body = document.getElementById("attendanceBody");

document.getElementById("datePicker").value =
    new Date().toISOString().substring(0, 10);

function saveAll() {
    localStorage.setItem("students", JSON.stringify(students));
    localStorage.setItem("attendance", JSON.stringify(attendance));
}

function addStudent() {
    let name = document.getElementById("studentName").value.trim();
    let father = document.getElementById("fatherName").value.trim();

    if (!name || !father) return alert("Enter both names!");

    students.push({name, father});
    saveAll();
    loadAttendance();

    document.getElementById("studentName").value = "";
    document.getElementById("fatherName").value = "";
}

function loadAttendance() {
    let date = document.getElementById("datePicker").value;

    if (!attendance[date]) {
        attendance[date] = students.map(() => ({status: "Not Marked"}));
    }

    body.innerHTML = "";

    students.forEach((stu, i) => {
        let s = attendance[date][i].status;

        body.innerHTML += `
        <tr>
            <td>${i+1}</td>
            <td>${stu.name}</td>
            <td>${stu.father}</td>
            <td>
                <span class="${s=='Present'?'present':'absent'}">${s}</span><br>
                <button class="btn-present" onclick="mark(${i},'Present')">Present</button>
                <button class="btn-absent" onclick="mark(${i},'Absent')">Absent</button>
            </td>
            <td>
                <button class="btn-edit" onclick="editStudent(${i})">Edit</button>
                <button class="btn-delete" onclick="deleteStudent(${i})">Delete</button>
            </td>
        </tr>`;
    });
}

function mark(i, type) {
    let date = document.getElementById("datePicker").value;
    attendance[date][i].status = type;
    saveAll();
    loadAttendance();
}

function editStudent(i) {
    let name = prompt("Edit Name:", students[i].name);
    let father = prompt("Edit Father Name:", students[i].father);

    if (name && father) {
        students[i].name = name;
        students[i].father = father;
        saveAll();
        loadAttendance();
    }
}

function deleteStudent(i) {
    if (!confirm("Delete this student?")) return;

    students.splice(i, 1);

    for (let d in attendance) {
        attendance[d].splice(i, 1);
    }

    saveAll();
    loadAttendance();
}

/* ---------------- EXPORT ---------------- */

function exportExcel() {
    let date = document.getElementById("datePicker").value;

    let exportData = students.map((s, i) => ({
        Roll: i+1,
        Name: s.name,
        Father_Name: s.father,
        Status: attendance[date][i].status
    }));

    let wb = XLSX.utils.book_new();
    let ws = XLSX.utils.json_to_sheet(exportData);
    XLSX.utils.book_append_sheet(wb, ws, "Attendance");
    XLSX.writeFile(wb, "Attendance_" + date + ".xlsx");
}

function exportPDF() {
    const { jsPDF } = window.jspdf;
    let doc = new jsPDF();
    let date = document.getElementById("datePicker").value;

    doc.text("Attendance Report - " + date, 20, 20);

    students.forEach((s, i) => {
        doc.text(
            `${i+1}. ${s.name} (Father: ${s.father}) - ${attendance[date][i].status}`,
            20, 40 + i*10
        );
    });

    doc.save("Attendance_" + date + ".pdf");
}

loadAttendance();
</script>

</body>
</html>
